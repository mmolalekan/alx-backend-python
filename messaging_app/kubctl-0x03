#!/usr/bin/env bash
# perform a rolling update on the blue deployment and probe availability
set -euo pipefail

NAMESPACE="${KUBE_NAMESPACE:-default}"
DEPLOYMENT_FILE="${DEPLOYMENT_FILE:-blue_deployment.yaml}"
DEPLOYMENT_NAME="${DEPLOYMENT_NAME:-messaging-app-blue}"
REQUEST_COUNT="${REQUEST_COUNT:-30}"
SLEEP_SECONDS="${SLEEP_SECONDS:-1}"
SERVICE_URL="${SERVICE_URL:-}"

kubectl apply -f "${DEPLOYMENT_FILE}" --namespace "${NAMESPACE}"

kubectl rollout status deployment.apps/${DEPLOYMENT_NAME} --namespace "${NAMESPACE}"

if command -v curl >/dev/null 2>&1; then
  if [[ -z "${SERVICE_URL}" ]]; then
    if command -v minikube >/dev/null 2>&1; then
      SERVICE_URL="$(minikube service messaging-app-active --namespace "${NAMESPACE}" --url 2>/dev/null | head -n1)"
    fi
  fi

  if [[ -n "${SERVICE_URL}" ]]; then
    echo "Probing ${SERVICE_URL} during rollout"
    for ((i = 1; i <= REQUEST_COUNT; i++)); do
      if ! curl --fail --silent --show-error "${SERVICE_URL}" >/dev/null; then
        echo "Request ${i} failed" >&2
      fi
      sleep "${SLEEP_SECONDS}"
    done
  else
    echo "SERVICE_URL is not set and could not be deduced; skipping curl probes" >&2
  fi
else
  echo "curl is not installed; skipping availability probes" >&2
fi

kubectl get pods --namespace "${NAMESPACE}" --selector="app=messaging-app" -o wide
